{% extends "base.html" %}
{% from "macros/wizard_steps.html" import step_bar %}

{% block title %}Admin Wallet - BlockHost Installer{% endblock %}

{% block content %}
{{ step_bar('wallet') }}

<div class="card" style="max-width: 560px; margin: 2rem auto;">
    <h2>Admin Wallet</h2>
    <p class="text-muted mb-2">
        Connect your OPNet wallet to identify yourself as the administrator of this BlockHost instance.
        This is required before proceeding with setup.
    </p>

    <!-- Step 1: Connect -->
    <div class="form-section" id="section-connect">
        <h3>Connect Wallet</h3>
        <div id="no-wallet" class="hidden">
            <div class="alert alert-error">
                No OPNet wallet detected. Please install the
                <a href="https://opwallet.org" target="_blank" style="color: var(--primary);">OPWallet</a>
                browser extension.
            </div>
        </div>
        <div id="wallet-disconnected">
            <button type="button" class="btn btn-primary" id="btn-connect" style="width: 100%;">
                Connect OPWallet
            </button>
        </div>
        <div id="wallet-connected" class="hidden">
            <div class="address-box">
                <span id="wallet-address" style="flex: 1; word-break: break-all;">-</span>
            </div>
        </div>
    </div>

    <!-- Step 2: Sign (shown after connect) -->
    <div class="form-section hidden" id="section-sign">
        <h3>Sign Authentication</h3>
        <p class="text-muted mb-2" style="font-size: 0.875rem;">
            Sign a message to create your admin credentials. This signature will be used to encrypt
            your access details into NFT #0.
        </p>
        <div style="margin-bottom: 1rem;">
            <label for="public-secret-input">Message to sign</label>
            <input type="text" id="public-secret-input" value="{{ public_secret | default('blockhost-access') }}"
                   style="font-size: 0.875rem;">
            <p class="text-muted mt-1" style="font-size: 0.75rem;">
                Your "public secret" &mdash; not a password, but you'll need to sign this same message
                to decrypt your NFT later. Make it something you'll remember.
            </p>
        </div>
        <button type="button" class="btn btn-primary" id="btn-sign" style="width: 100%;">
            Sign Message
        </button>
        <div id="sign-status"></div>
    </div>

    <!-- Step 3: Confirmed (shown after sign) -->
    <div class="form-section hidden" id="section-confirmed">
        <h3>Admin Identity Confirmed</h3>
        <div class="alert alert-success">
            Wallet connected and signature captured. Your admin credentials are ready.
        </div>
        <div style="margin-top: 1rem;">
            <div class="summary-item">
                <span class="summary-label">Admin Wallet</span>
                <span class="summary-value" id="confirmed-address" style="font-size: 0.8rem;">-</span>
            </div>
        </div>
    </div>

    <!-- Step 4: Restore config (shown after sign) -->
    <div class="form-section hidden" id="section-restore">
        <h3>Restore Settings</h3>
        <p class="text-muted mb-2" style="font-size: 0.875rem;">
            Have an encrypted config file from a previous setup? Upload it to restore your settings.
            The file can only be decrypted if you signed the same message as when it was created.
        </p>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="file" id="restore-file" accept=".enc" style="flex: 1; font-size: 0.875rem;">
            <button type="button" class="btn btn-secondary" id="btn-restore" onclick="restoreConfig()">
                Restore
            </button>
        </div>
        <div id="restore-status" style="margin-top: 0.5rem;"></div>
    </div>

    <!-- Hidden form for POST -->
    <form method="POST" action="{{ url_for('wizard_wallet') }}" id="wallet-form" class="hidden">
        <input type="hidden" name="admin_wallet" id="input-wallet">
        <input type="hidden" name="admin_signature" id="input-signature">
        <input type="hidden" name="public_secret" id="input-public-secret">
    </form>

    <div class="flex justify-between" style="margin-top: 2rem;">
        <span></span>
        <button type="button" class="btn btn-primary" id="btn-continue" disabled onclick="submitForm()">
            Continue to Setup
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var $ = function(id) { return document.getElementById(id); };
var adminAddress = null;
var adminSignature = null;
var publicSecret = null;

// Connect wallet via OPWallet extension
$('btn-connect').addEventListener('click', function() {
    if (!window.opnet) {
        $('no-wallet').classList.remove('hidden');
        $('wallet-disconnected').classList.add('hidden');
        return;
    }

    $('btn-connect').disabled = true;
    $('btn-connect').textContent = 'Connecting...';

    window.opnet.requestAccounts()
    .then(function(accounts) {
        if (!accounts || !accounts.length) {
            throw new Error('No accounts returned');
        }
        adminAddress = accounts[0];

        // Display connected wallet
        $('wallet-address').textContent = adminAddress;
        $('wallet-disconnected').classList.add('hidden');
        $('wallet-connected').classList.remove('hidden');

        // Show sign section
        $('section-sign').classList.remove('hidden');
    })
    .catch(function(e) {
        $('btn-connect').disabled = false;
        $('btn-connect').textContent = 'Connect OPWallet';
        if (e.code === 4001) {
            // User rejected
        } else {
            console.error('Connect error:', e);
        }
    });
});

// Sign message via OPWallet (ML-DSA signature)
$('btn-sign').addEventListener('click', function() {
    publicSecret = $('public-secret-input').value.trim();
    if (!publicSecret) {
        $('sign-status').innerHTML = '<div class="alert alert-error" style="margin-top: 0.5rem;">Please enter a message to sign.</div>';
        return;
    }

    $('btn-sign').disabled = true;
    $('btn-sign').textContent = 'Waiting for signature...';

    window.opnet.signMessage(publicSecret, 'schnorr')
    .then(function(sig) {
        adminSignature = typeof sig === 'string' ? sig : Array.from(new Uint8Array(sig)).map(function(b) { return ('0' + b.toString(16)).slice(-2); }).join('');
        if (!adminSignature.startsWith('0x')) adminSignature = '0x' + adminSignature;

        // Update UI
        $('section-sign').classList.add('hidden');
        $('section-confirmed').classList.remove('hidden');
        $('section-restore').classList.remove('hidden');
        $('confirmed-address').textContent = adminAddress;

        // Fill hidden form
        $('input-wallet').value = adminAddress;
        $('input-signature').value = adminSignature;
        $('input-public-secret').value = publicSecret;

        // Enable continue
        $('btn-continue').disabled = false;
    })
    .catch(function(e) {
        $('btn-sign').disabled = false;
        $('btn-sign').textContent = 'Sign Message';
        if (e.code === 4001) {
            $('sign-status').innerHTML = '<div class="alert alert-error" style="margin-top: 0.5rem;">Signature rejected by user.</div>';
        } else {
            $('sign-status').innerHTML = '<div class="alert alert-error" style="margin-top: 0.5rem;">' + (e.message || e) + '</div>';
        }
        console.error('Sign error:', e);
    });
});

function submitForm() {
    $('wallet-form').submit();
}

function restoreConfig() {
    var fileInput = $('restore-file');
    var statusEl = $('restore-status');

    if (!fileInput.files.length) {
        statusEl.innerHTML = '<div class="alert alert-error">Please select a .enc file.</div>';
        return;
    }
    if (!adminSignature) {
        statusEl.innerHTML = '<div class="alert alert-error">Sign with your wallet first.</div>';
        return;
    }

    $('btn-restore').disabled = true;
    $('btn-restore').textContent = 'Decrypting...';
    statusEl.innerHTML = '';

    var formData = new FormData();
    formData.append('config_file', fileInput.files[0]);
    formData.append('admin_signature', adminSignature);

    fetch('/api/restore-config', { method: 'POST', body: formData })
    .then(function(resp) {
        return resp.json().then(function(data) { return { ok: resp.ok, data: data }; });
    })
    .then(function(result) {
        if (result.ok && result.data.redirect) {
            statusEl.innerHTML = '<div class="alert alert-success">Config restored. Redirecting to finalization...</div>';
            setTimeout(function() { window.location.href = result.data.redirect; }, 1000);
        } else {
            statusEl.innerHTML = '<div class="alert alert-error">' + (result.data.error || 'Restore failed') + '</div>';
            $('btn-restore').disabled = false;
            $('btn-restore').textContent = 'Restore';
        }
    })
    .catch(function(e) {
        statusEl.innerHTML = '<div class="alert alert-error">Network error: ' + e.message + '</div>';
        $('btn-restore').disabled = false;
        $('btn-restore').textContent = 'Restore';
    });
}
</script>
{% endblock %}
